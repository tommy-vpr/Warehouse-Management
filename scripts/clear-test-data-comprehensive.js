const { PrismaClient } = require("@prisma/client");
const prisma = new PrismaClient();

async function clearTestData() {
  console.log("üßπ Clearing all test data from database...");
  console.log("‚ö†Ô∏è  This will delete ALL data except users - are you sure?");

  try {
    console.log("üóëÔ∏è  Deleting data in correct order...");

    // Delete in reverse order of dependencies to avoid foreign key constraints

    // ==============================================
    // 1. PICKING SYSTEM (most dependent)
    // ==============================================
    console.log("\nüì¶ Clearing picking system data...");

    const pickEventCount = await prisma.pickEvent.deleteMany({});
    console.log(`‚úÖ Deleted ${pickEventCount.count} pick events`);

    const pickListItemCount = await prisma.pickListItem.deleteMany({});
    console.log(`‚úÖ Deleted ${pickListItemCount.count} pick list items`);

    const pickListCount = await prisma.pickList.deleteMany({});
    console.log(`‚úÖ Deleted ${pickListCount.count} pick lists`);

    // ==============================================
    // 2. CYCLE COUNTING SYSTEM
    // ==============================================
    console.log("\nüìä Clearing cycle counting data...");

    const cycleCountEventCount = await prisma.cycleCountEvent.deleteMany({});
    console.log(`‚úÖ Deleted ${cycleCountEventCount.count} cycle count events`);

    const cycleCountTaskCount = await prisma.cycleCountTask.deleteMany({});
    console.log(`‚úÖ Deleted ${cycleCountTaskCount.count} cycle count tasks`);

    const cycleCountCampaignCount = await prisma.cycleCountCampaign.deleteMany(
      {}
    );
    console.log(
      `‚úÖ Deleted ${cycleCountCampaignCount.count} cycle count campaigns`
    );

    // ==============================================
    // 3. SHIPPING & BACK ORDERS
    // ==============================================
    console.log("\nüöö Clearing shipping and back order data...");

    const shippingPackageCount = await prisma.shippingPackage.deleteMany({});
    console.log(`‚úÖ Deleted ${shippingPackageCount.count} shipping packages`);

    const backOrderCount = await prisma.backOrder.deleteMany({});
    console.log(`‚úÖ Deleted ${backOrderCount.count} back orders`);

    // ==============================================
    // 4. ORDERS
    // ==============================================
    console.log("\nüìã Clearing order data...");

    const orderStatusHistoryCount = await prisma.orderStatusHistory.deleteMany(
      {}
    );
    console.log(
      `‚úÖ Deleted ${orderStatusHistoryCount.count} order status history records`
    );

    const orderItemCount = await prisma.orderItem.deleteMany({});
    console.log(`‚úÖ Deleted ${orderItemCount.count} order items`);

    const orderCount = await prisma.order.deleteMany({});
    console.log(`‚úÖ Deleted ${orderCount.count} orders`);

    // ==============================================
    // 5. PURCHASE ORDERS
    // ==============================================
    console.log("\nüõí Clearing purchase order data...");

    const purchaseOrderItemCount = await prisma.purchaseOrderItem.deleteMany(
      {}
    );
    console.log(
      `‚úÖ Deleted ${purchaseOrderItemCount.count} purchase order items`
    );

    const purchaseOrderCount = await prisma.purchaseOrder.deleteMany({});
    console.log(`‚úÖ Deleted ${purchaseOrderCount.count} purchase orders`);

    // ==============================================
    // 6. INVENTORY PLANNER DATA
    // ==============================================
    console.log("\nüìà Clearing Inventory Planner sync data...");

    const inventoryPlannerPOLineCount =
      await prisma.inventoryPlannerPOLine.deleteMany({});
    console.log(`‚úÖ Deleted ${inventoryPlannerPOLineCount.count} IP PO lines`);

    const inventoryPlannerPOCount =
      await prisma.inventoryPlannerPurchaseOrder.deleteMany({});
    console.log(
      `‚úÖ Deleted ${inventoryPlannerPOCount.count} IP purchase orders`
    );

    const forecastSuggestionCount = await prisma.forecastSuggestion.deleteMany(
      {}
    );
    console.log(
      `‚úÖ Deleted ${forecastSuggestionCount.count} forecast suggestions`
    );

    const syncProgressCount = await prisma.syncProgress.deleteMany({});
    console.log(`‚úÖ Deleted ${syncProgressCount.count} sync progress records`);

    const syncLogCount = await prisma.syncLog.deleteMany({});
    console.log(`‚úÖ Deleted ${syncLogCount.count} sync logs`);

    // ==============================================
    // 7. INVENTORY TRANSACTIONS
    // ==============================================
    console.log("\nüìä Clearing inventory transactions...");

    const transactionCount = await prisma.inventoryTransaction.deleteMany({});
    console.log(`‚úÖ Deleted ${transactionCount.count} inventory transactions`);

    // ==============================================
    // 8. INVENTORY (stock levels)
    // ==============================================
    console.log("\nüì¶ Clearing inventory records...");

    const inventoryCount = await prisma.inventory.deleteMany({});
    console.log(`‚úÖ Deleted ${inventoryCount.count} inventory records`);

    // ==============================================
    // 9. PRODUCTS & VARIANTS
    // ==============================================
    console.log("\nüè∑Ô∏è  Clearing product data...");

    const variantCount = await prisma.productVariant.deleteMany({});
    console.log(`‚úÖ Deleted ${variantCount.count} product variants`);

    const productCount = await prisma.product.deleteMany({});
    console.log(`‚úÖ Deleted ${productCount.count} products`);

    // ==============================================
    // 10. LOCATIONS
    // ==============================================
    console.log("\nüìç Clearing location data...");

    const locationCount = await prisma.location.deleteMany({});
    console.log(`‚úÖ Deleted ${locationCount.count} locations`);

    // ==============================================
    // 11. NOTIFICATIONS
    // ==============================================
    console.log("\nüîî Clearing notifications...");

    const notificationCount = await prisma.notification.deleteMany({});
    console.log(`‚úÖ Deleted ${notificationCount.count} notifications`);

    // ==============================================
    // 12. AUTH DATA (but keep users)
    // ==============================================
    console.log("\nüîê Clearing auth sessions (keeping users)...");

    const sessionCount = await prisma.session.deleteMany({});
    console.log(`‚úÖ Deleted ${sessionCount.count} sessions`);

    const accountCount = await prisma.account.deleteMany({});
    console.log(`‚úÖ Deleted ${accountCount.count} accounts`);

    const userCredentialCount = await prisma.userCredential.deleteMany({});
    console.log(`‚úÖ Deleted ${userCredentialCount.count} user credentials`);

    // ==============================================
    // Optional: Delete users (KEEP COMMENTED)
    // ==============================================
    // console.log("\nüë§ Clearing users...")
    // const userCount = await prisma.user.deleteMany({})
    // console.log(`‚úÖ Deleted ${userCount.count} users`)

    // ==============================================
    // SUMMARY
    // ==============================================
    console.log("\n" + "=".repeat(50));
    console.log("üéâ All test data cleared successfully!");
    console.log("=".repeat(50));
    console.log("üìã Database is now clean and ready for fresh data");
    console.log("üë§ Users have been preserved");
    console.log(
      "üîê Auth sessions have been cleared (users will need to log in again)"
    );
    console.log("\nüìä Deleted totals:");
    console.log(`   ‚Ä¢ Pick Events: ${pickEventCount.count}`);
    console.log(`   ‚Ä¢ Pick List Items: ${pickListItemCount.count}`);
    console.log(`   ‚Ä¢ Pick Lists: ${pickListCount.count}`);
    console.log(`   ‚Ä¢ Cycle Count Events: ${cycleCountEventCount.count}`);
    console.log(`   ‚Ä¢ Cycle Count Tasks: ${cycleCountTaskCount.count}`);
    console.log(`   ‚Ä¢ Cycle Count Campaigns: ${cycleCountCampaignCount.count}`);
    console.log(`   ‚Ä¢ Shipping Packages: ${shippingPackageCount.count}`);
    console.log(`   ‚Ä¢ Back Orders: ${backOrderCount.count}`);
    console.log(`   ‚Ä¢ Order Status History: ${orderStatusHistoryCount.count}`);
    console.log(`   ‚Ä¢ Order Items: ${orderItemCount.count}`);
    console.log(`   ‚Ä¢ Orders: ${orderCount.count}`);
    console.log(`   ‚Ä¢ Purchase Order Items: ${purchaseOrderItemCount.count}`);
    console.log(`   ‚Ä¢ Purchase Orders: ${purchaseOrderCount.count}`);
    console.log(`   ‚Ä¢ IP PO Lines: ${inventoryPlannerPOLineCount.count}`);
    console.log(`   ‚Ä¢ IP Purchase Orders: ${inventoryPlannerPOCount.count}`);
    console.log(`   ‚Ä¢ Forecast Suggestions: ${forecastSuggestionCount.count}`);
    console.log(`   ‚Ä¢ Sync Progress: ${syncProgressCount.count}`);
    console.log(`   ‚Ä¢ Sync Logs: ${syncLogCount.count}`);
    console.log(`   ‚Ä¢ Inventory Transactions: ${transactionCount.count}`);
    console.log(`   ‚Ä¢ Inventory Records: ${inventoryCount.count}`);
    console.log(`   ‚Ä¢ Product Variants: ${variantCount.count}`);
    console.log(`   ‚Ä¢ Products: ${productCount.count}`);
    console.log(`   ‚Ä¢ Locations: ${locationCount.count}`);
    console.log(`   ‚Ä¢ Notifications: ${notificationCount.count}`);
    console.log(`   ‚Ä¢ Sessions: ${sessionCount.count}`);
    console.log(`   ‚Ä¢ Accounts: ${accountCount.count}`);
    console.log(`   ‚Ä¢ User Credentials: ${userCredentialCount.count}`);
    console.log("=".repeat(50));
  } catch (error) {
    console.error("\n‚ùå Error clearing data:", error.message);
    console.error("\nüîç Full error details:");
    console.error(error);

    if (error.message.includes("Foreign key constraint")) {
      console.log("\nüí° Foreign key constraint error detected.");
      console.log("This usually means the deletion order needs adjustment.");
      console.log("Check which table is causing issues and update the script.");
    }
  } finally {
    await prisma.$disconnect();
  }
}

// Run the function
clearTestData()
  .then(() => {
    console.log("\n‚ú® Script completed");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\nüí• Script failed:", error);
    process.exit(1);
  });
